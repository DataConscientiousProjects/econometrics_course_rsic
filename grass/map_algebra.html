<P>
Resources: <a href="http://grass.osgeo.org/grass70/manuals/index.html">
GRASS GIS overview and manual</a>

<P><B>Topic: Geospatial Analysis I: global, zonal and focal operations, map algebra</B></P>
<!--<p><B>Task: compute summaries, use map algebra to analyze, modify and derive new maps, 
explain difference between operations on discrete and continuous data
</B></p>-->
<!-- TODO
- try to redefine below into larger meaningful examples 
- improve the SRTM difference example to show the impact of 0, null on univar
- test and improve the MASK examples
-->
On MSWindows, it is recommended to use wxGUI equivalents of d.* commands:</font><br>
use their GUI equivalents,
see assignment <a href="data_visualization.html">Data display and visualization</a>
<p>
To start the GUI for a given command, just type or paste the name of the command 
into Comand console and Enter. Read the manual page for each new command to learn what it does 
and what the options mean. You can find the manual page under Manual tab in the command GUI
or use the
 <a href="http://grass.osgeo.org/grass70/manuals/index.html">GRASS manual.</a>
<p>
To run mapcalc expressions, you can either run the entire command in the GUI Command console,
or in case of any problems, type or copy the expression in the GRASS GIS Raster Map Calculator
which can be launched from Layer Manager toolbar.
</p>


<pre><code>
grass70
</code></pre>

<p>
in the startup pannel<br>
GIS data directory: type path to GRASS datasets<br>
LOCATION: select nc_spm_08<br>
MAPSET: use mapset with your unity ID or user1<br>
Enter GRASS<br>

Compute summaries<br>
p.90<br>
Compute areas for each category at two different resolutions<br>
Are results equal? Explain (see also Lecture 1)<br>
Copy and paste the report from the output window or<br>
Save the report in a text file: Output window > Save<br>
Use fixed width font (e.g., Courier, Andale Mono  in your report to preserve formatting)<br>

<pre><code>
g.region rast=landuse96_28m res=12 -ap
r.report landuse96_28m unit=c,h,p
g.region rast=landuse96_28m res=30 -ap
r.report landuse96_28m unit=c,h,p
</code></pre>

<p>
Compute areas for each category of land use for each zipcode<br>
Compare 27601 Raleigh with 27511 Cary<br>
Include only the relevant part of the Table in your report<br>

<pre><code>
r.report zipcodes,landuse96_28m unit=h,p
</code></pre>

<p>
Compute zonal statistics maps representing<br>
average slope for each basin<br>
add legends using Add legend in GUI (the pannel may open behind your map display)<br>
reminder: d.out.file means Save to graphics file for your report<br>

<pre><code>
g.region rast=slope -p
r.stats.zonal base=basin_50K cover=slope method=average output=slope_avgbasin
r.colors slope_avgbasin co=gyr
d.rast slope_avgbasin
d.legend slope_avgbasin at=90,50,5,8
d.vect streams color=15:25:110
d.out.file slope_avgbasin
</code></pre>

<p>
Compute zonal statistics maps representing most common land use for each basin<br>
When adding legend, make sure you define "List of discrete category numbers"<br>

<pre><code>
g.region rast=landuse96_28m -p
r.mode base=basin_50K cover=landuse96_28m out=landuse96_modebasin
d.rast landuse96_modebasin
d.vect streams
d.legend landuse96_modebasin at=40,20,2,5 -n
d.out.file landuse96_modezip
</code></pre>

<p>
Apply neighborhood operators<br>
p.127<br>
use neighborhood operator to compute land use diversity map<br>
for d.erase: Zoom to computational region and switch off previous map layers<br>
How diverse is land use in NCSU area?  Would you change it?<br>

<pre><code>
g.region rast=landuse96_28m -p
r.info -g landuse96_28m
r.neighbors landuse96_28m out=lu_divers method=diversity size=7
d.erase
d.rast lu_divers
d.legend lu_divers at=70,15,5,10 -v
d.vect streets_wake
r.report lu_divers unit=p
</code></pre>

<p>
use neighborhood operator to smooth the SRTM elevation map<br>
compare the global statistical measures for the original and smoothed DEM<br>
for d.erase: Zoom to computational region and switch off previous map layers<br>
How would size of the neighborhood influence the result?<br>

<pre><code>
g.region rast=elev_srtm_30m -p
r.neighbors elev_srtm_30m out=elev_srtm30m_sm5 method=average size=5
d.rast elev_srtm_30m
d.rast elev_srtm30m_sm5
r.univar elev_srtm_30m
r.univar elev_srtm30m_sm5
</code></pre>

<p>
Patch multiple raster layers into a single raster<br>
p.124-125<br>
patch raster tiles for lidar based, 6m res. DEM for Centennial Campus<br>
on MS VISTA you need to have UAC (User Account Control) disabled to run r.patch<br>

<pre><code>
g.region rast=el_D793_6m,el_D783_6m,el_D782_6m,el_D792_6m -p
r.patch in=el_D793_6m,el_D783_6m,el_D782_6m,el_D792_6m out=elevlidD_6m
r.colors elevlidD_6m rast=elevation
d.erase
d.rast elevlidD_6m
</code></pre>

<p>
patching discrete raster layers over continuous raster<br>

<pre><code>
g.region rast=elev_ned_30m -p
r.patch roadsmajor,facility,lakes,elevation out=composite
</code></pre>

<p>
assign colors to the composite based on raster values<br>
first check the range of values in each raster<br>
they are very different so custom color table is needed<br>

<pre><code>
r.info -r roadsmajor
r.info -r facility
r.info -r lakes
r.info -r elevation
</code></pre>

<p>
assign the custom color table<br>
<a href="rastcomposite_color.txt">download rastcomposite_color.txt</a><br>
GUI: Edit layer settings>Set color table>Colors>Path to rules file<br>
or just type r.colors into Cmd and hit Enter<br>
Browser will pick up the full path to your color rules file<br>
on MS Windows the command below assumes that the color table is in your msys home directory<br>
for d.erase: Zoom to computational region and switch off previous map layers<br>

<pre><code>
r.colors composite rules=rastcomposite_color.txt
d.erase
d.rast composite
d.out.file composite

</code></pre>

<p>
Map Algebra<br>
<a href="http://grass.osgeo.org/grass70/manuals/r.mapcalc.html"><br>
see <b>r.mapcalc</b></a> manual page for syntax and functions<br>
# p. 107-108 <!--# <a href="mapcalcformats.html">See here for several ways on <b>how to run r.mapcalc</b></a>-->
<b>if you are getting en error when running r.mapcalc in command console use the GUI version</b><br>

compute Normalized Difference Vegetation Index (NDVI)<br>
explain the difference between floating point and integer<br>
handling in ndvi1, ndvi2 and ndvi3 result<br>

<pre><code>
g.region rast=lsat7_2002_40 -p
r.mapcalc "ndvi1 = (lsat7_2002_40 - lsat7_2002_30) / (lsat7_2002_40 + lsat7_2002_30)"
r.mapcalc "ndvi2 = 1.0 * (lsat7_2002_40 - lsat7_2002_30) / (lsat7_2002_40 + lsat7_2002_30)"
r.mapcalc "ndvi3 = float(lsat7_2002_40 - lsat7_2002_30) / float(lsat7_2002_40 + lsat7_2002_30)"
r.info -r ndvi1
r.info -r ndvi2
r.info -r ndvi3
r.colors ndvi3 co=ndvi
d.rast ndvi3
d.out.file ndvi3
</code></pre>

<p>
explore the difference between the SRTM DSM and lidar-based NED DEM<br>
compute the map of elevation differences<br>

<pre><code>
g.region rast=elev_ned_30m -p
r.mapcalc "srtm_ned30_dif = elev_srtm_30m - elev_ned_30m"
</code></pre>

<p>
create a custom color table to distinguish the negative and positive values<br>

<pre><code>
r.info -r srtm_ned30_dif
</code></pre>

<p>
fp: Data range is -142.24... to 86.19...<br>
<a href="srtmneddiff_color.txt">download srtmneddiff_color.txt</a><br>
GUI: Edit layer settings>Set color table>Colors>Path to rules file<br>
for d.erase: Zoom to computational region and switch off previous map layers<br>

<pre><code>
r.colors srtm_ned30_dif rules=srtmneddiff_color.txt
d.erase
</code></pre>

<p>
GUI: use second button on Map display to redraw<br>

<pre><code>
d.rast srtm_ned30_dif
d.legend srtm_ned30_dif at=70,15,5,10
d.vect streets_wake
d.out.file srtm_ned30_dif
r.univar elev_srtm_30m
r.univar elev_ned_30m
</code></pre>

<p>
is the srtm mostly higher or lower than elev_ned?<br>
which result will you use to answer the above question -<br>
the srtm_ned30_dif map or numbers provided by r.univar?<br>
<!--
<font color="#000066">
# check the imapct of NULL on map algebra operation
# create a copy of SRTM DSM map
# replace cells with elevation=0 by NULL (NULLs will be transparent)
# what is the mean and range of differences when using 0 and NULL?
</font>
g.copy rast=elev_srtm_30m,myelev_srtm_30m
g.region rast=myelev_srtm_30m -p
d.rast myelev_srtm_30m
r.null myelev_srtm_30m setnull=0.
r.mapcalc mysrtm_ned30_dif=myelev_srtm_30m-elev_ned_30m
r.colors mysrtm_ned30_dif rast=srtm_ned30_dif
d.rast srtm_ned30_dif
d.rast mysrtm_ned30_dif
r.univar myelev_srtm_30m
-->
p. 109<br>
working with if statements<br>
create map of urban areas (high density and low density class)<br>
with 0 class elsewhere<br>

<pre><code>
g.region rast=landuse96_28m -p
r.mapcalc "urban1_30m = if(landuse96_28m == 1,1,0) + if(landuse96_28m == 2,2,0)"
d.rast urban1_30m
d.legend urban1_30m at=10,30,5,8
</code></pre>

<p>
alternatively with logical 'or' operator and null elsewhere<br>

<pre><code>
r.mapcalc "urban2_30m = if(landuse96_28m == 1 || landuse96_28m == 2,landuse96_28m,null())"
d.rast urban2_30m
</code></pre>

<p>
p. 110-111<br>
handling null values<br>
replace lakes in the landclass96 map with more accurate representation<br>
from raster map lakes, we divide lakes by 1000 because the lake map has<br>
large numbers that would have required custom color table<br>

<pre><code>
r.mapcalc "luselakes = if(isnull(lakes),landclass96,lakes/1000)"
d.rast luselakes
d.out.file luselakes
</code></pre>

<p>
<!--
<font color="#000066">
# create a map of developed areas where all land use categories > 1 are set to null
</font>
r.mapcalc developed=if(landclass96 > 1, null(), 1)
-->
create mask for low lying developed areas (e.g. vulnerable to flooding)<br>
with elevation between 60 and 100m and land use 1 or 2<br>
set the region, display the input maps and create a MASK<br>
for d.erase: Zoom to computational region and switch off previous map layers<br>

<pre><code>
g.region rast=elevation -p
d.erase
d.rast elevation
d.rast landuse96_28m
r.mapcalc "MASK = if((elevation < 100 && elevation > 60) && (landuse96_28m == 1 || landuse96_28m == 2),1,null())"
</code></pre>

<p>
display watersheds to see the MASK effect<br>

<pre><code>
d.rast basin_50K
d.out.file basin_masked
</code></pre>

<p>
rename MASK to disable it, and display basin_50K again<br>
to show that the MASK was removed<br>

<pre><code>
g.rename rast=MASK,maskfile
d.rast basin_50K
</code></pre>

<p>
p. 114<br>
replace section of SRTM DSM with NED DEM elevation<br>

<pre><code>
r.mapcalc "elev_combined = if(y() < 224274. && x() > 637455., elevation, elev_srtm_30m)"
</code></pre>

<p>
create a raster map representing tilted plane (e.g., geologic fault)<br>

<pre><code>
g.region rural_1m -p
r.mapcalc "tiltplane = 0.2*(0.1*row()+col())+50"
r.mapcalc "tiltpl_under = if(tiltplane < elev_lid792_1m + 2,tiltplane,null())"
</code></pre>

<p>
view the elevation surface and subsurface plane in 3D<br>
switch off all layers in the layer manager except for elev_lid792_1m and tiltpl_under<br>
change display to 3D view, adjust viewing position to a view from South<br>
save an image for your report<br>

<b>Optional:</b> Various additional useful tasks<br>
p. 91<br>
use map algebra to create map subsets<br>
change region to the airphoto tile 792 and resolution 10m<br>

<pre><code>
g.region rast=ortho_2001_t792_1m res=10 -ap
d.erase
d.rast ortho_2001_t792_1m
</code></pre>

<p>
create a subset of the map elevation for this subregion<br>

<pre><code>
r.mapcalc "elevation_792_10m = elevation"
d.rast elevation_792_10m
</code></pre>

<p>
zoom out to see that it is a subset<br>

<pre><code>
</code></pre>

<p>
Work with NULL and MASK<br>
p. 103-104<br>
set the mask and check its effect<br>

<pre><code>
d.rast elevation
d.vect streets_wake
r.mask urban maskcats=55
d.rast elevation
</code></pre>

<p>
remove mask - any of the two commands below should work<br>

<pre><code>
r.mask -r 
g.remove rast=MASK
</code></pre>

<p>
Compute %area for each category in each zipcode<br>
which zipcode has the most high density development?<br>

<pre><code>
r.stats -pl zipcodes,landuse96_28m
</code></pre>

<p>
p. 113<br>
working with relative coordinates<br>
enter the expression on a single line without \<br>

<pre><code>
g.region rast=elev_srtm_30m -p
d.erase
r.mapcalc "elev_srtm30m_smooth = (elev_srtm_30m[-1,-1]   \
           + elev_srtm_30m[-1,0] + elev_srtm_30m[-1,1] \
           + elev_srtm_30m[0,-1] + elev_srtm_30m[0,0]  \
           + elev_srtm_30m[0,1]  + elev_srtm_30m[1,-1] \
           + elev_srtm_30m[1,0]  + elev_srtm_30m[1,1])/9."
</code></pre>

<p>
assign the resulting map the same color table as the original<br>
compare global statistics<br>

<pre><code>
r.colors elev_srtm30m_smooth rast=elev_srtm_30m
r.univar elev_srtm_30m
r.univar elev_srtm30m_smooth
d.rast elev_srtm_30m
d.rast elev_srtm30m_smooth
</div>
